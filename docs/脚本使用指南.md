# PowerShell 脚本使用指南

本文档说明项目根目录下所有 PowerShell 脚本的用途和使用方法。

## 📋 脚本概览

| 脚本名称 | 用途 | 使用频率 |
|---------|------|---------|
| `setup-ffmpeg-windows.ps1` | FFmpeg 环境配置 | 首次安装 |
| `quick-test-setup.ps1` | 快速测试环境配置 | 开发测试 |
| `start-all-simple.ps1` | 启动所有服务 | 日常使用 |
| `test-live-streaming.ps1` | 端到端集成测试 | 功能验证 |
| `run-full-test.ps1` | 完整测试流程 | 自动化测试 |
| `generate-test-h264.ps1` | 生成测试视频文件 | 测试准备 |

---

## 🔧 环境配置脚本

### setup-ffmpeg-windows.ps1

**用途**: 在 Windows 系统上配置 FFmpeg 开发环境，用于真实屏幕录制功能。

**功能**:
- 自动下载 FFmpeg 开发库
- 配置环境变量（FFMPEG_DIR, PKG_CONFIG_PATH）
- 创建 pkg-config 配置文件
- 验证安装是否成功

**使用场景**:
- 首次搭建开发环境
- 需要使用真实屏幕录制功能时
- FFmpeg 环境出现问题需要重新配置

**使用方法**:
```powershell
.\setup-ffmpeg-windows.ps1
```

**注意事项**:
- 建议以管理员身份运行
- 需要网络连接下载 FFmpeg
- 执行后需要重启 PowerShell 使环境变量生效

---

### quick-test-setup.ps1

**用途**: 快速配置测试环境，使用模拟数据代替真实屏幕录制。

**功能**:
- 切换到模拟数据生成器（无需 FFmpeg）
- 注释 FFmpeg 相关依赖
- 清理并重新编译项目
- 提供下一步操作指引

**使用场景**:
- 快速验证功能（无需配置 FFmpeg）
- 开发测试阶段
- CI/CD 自动化测试

**使用方法**:
```powershell
.\quick-test-setup.ps1
```

**恢复真实屏幕录制**:
```powershell
# 恢复备份文件
Copy-Item device-simulator\src\video\mod.rs.backup device-simulator\src\video\mod.rs -Force
Copy-Item device-simulator\Cargo.toml.backup device-simulator\Cargo.toml -Force

# 重新编译
cd device-simulator
cargo build
cd ..
```

---

## 🚀 服务启动脚本

### start-all-simple.ps1

**用途**: 启动所有系统服务（平台服务器、设备模拟器、前端）。

**功能**:
- 检查编译状态
- 后台启动所有服务
- 保存 Job IDs 到文件
- 提供服务管理命令

**使用方法**:
```powershell
.\start-all-simple.ps1
```

**服务信息**:
- 平台服务器: http://localhost:8080
- 前端界面: http://localhost:5173
- 设备ID: device_001

**查看日志**:
```powershell
# 查看平台服务器日志
Receive-Job -Id <平台Job ID> -Keep

# 查看设备模拟器日志
Receive-Job -Id <设备Job ID> -Keep

# 查看前端日志
Receive-Job -Id <前端Job ID> -Keep
```

**停止服务**:
```powershell
# 读取保存的 Job IDs
$jobs = Get-Content .job-ids.json | ConvertFrom-Json

# 停止所有服务
Stop-Job -Id $jobs.Platform,$jobs.Device,$jobs.Frontend
Remove-Job -Id $jobs.Platform,$jobs.Device,$jobs.Frontend
```

---

## 🧪 测试脚本

### test-live-streaming.ps1

**用途**: 端到端直通播放集成测试，验证所有核心功能。

**测试项目**:
1. 系统组件状态检查
2. 启动直通播放
3. 视频分片实时传输验证
4. 端到端延迟验证（<100ms）
5. 暂停/恢复功能测试
6. 停止流测试

**使用方法**:
```powershell
# 确保服务已启动
.\start-all-simple.ps1

# 等待 10-20 秒后运行测试
.\test-live-streaming.ps1
```

**测试结果**:
- 测试报告保存在 `test-results-live-streaming-*.json`
- 通过率 ≥80% 视为测试通过
- 自动生成详细的测试统计信息

---

### run-full-test.ps1

**用途**: 一键执行完整测试流程（配置 → 编译 → 启动 → 测试）。

**功能**:
- 自动执行 `quick-test-setup.ps1`
- 自动执行 `start-all-simple.ps1`
- 自动执行 `test-live-streaming.ps1`
- 提供详细的执行日志

**使用方法**:
```powershell
# 完整流程（包括配置和测试）
.\run-full-test.ps1

# 跳过配置，直接启动和测试
.\run-full-test.ps1 -SkipSetup

# 只启动服务，不运行测试
.\run-full-test.ps1 -SkipTest
```

**适用场景**:
- 自动化测试
- CI/CD 流程
- 快速验证整体功能

---

## 🎬 测试数据生成脚本

### generate-test-h264.ps1

**用途**: 生成测试用的 H.264 视频文件。

**功能**:
- 生成彩色测试图案（10秒）
- 录制屏幕（10秒）
- 生成简单动画（10秒）

**使用方法**:
```powershell
.\generate-test-h264.ps1
```

**前置条件**:
- 需要安装 FFmpeg（可运行 `setup-ffmpeg-windows.ps1` 安装）

**输出位置**:
- `device-simulator\test-videos\test-live-*.h264`

**使用场景**:
- 准备测试视频素材
- 验证视频编码参数
- 测试不同类型的视频内容

---

## 📊 典型使用流程

### 流程 1: 首次环境搭建（使用模拟数据）

```powershell
# 1. 配置测试环境
.\quick-test-setup.ps1

# 2. 启动所有服务
.\start-all-simple.ps1

# 3. 等待 10-20 秒

# 4. 运行测试
.\test-live-streaming.ps1
```

### 流程 2: 首次环境搭建（使用真实屏幕录制）

```powershell
# 1. 配置 FFmpeg 环境
.\setup-ffmpeg-windows.ps1

# 2. 重启 PowerShell

# 3. 编译项目
cd device-simulator
cargo build
cd ..

cd platform-server
cargo build
cd ..

# 4. 启动所有服务
.\start-all-simple.ps1

# 5. 运行测试
.\test-live-streaming.ps1
```

### 流程 3: 日常开发测试

```powershell
# 1. 启动服务
.\start-all-simple.ps1

# 2. 手动测试
# 访问 http://localhost:5173

# 3. 或运行自动化测试
.\test-live-streaming.ps1
```

### 流程 4: 一键自动化测试

```powershell
# 完整流程
.\run-full-test.ps1
```

---

## ⚠️ 常见问题

### Q1: 服务启动失败

**检查项**:
1. 确认项目已编译：检查 `target\debug` 目录
2. 确认端口未被占用：8080, 5173, 8443
3. 查看服务日志：使用 `Receive-Job` 命令

### Q2: 测试失败

**排查步骤**:
1. 确认所有服务已启动并运行正常
2. 检查设备是否在线：访问 http://localhost:8080/api/v1/devices
3. 查看测试报告：`test-results-*.json`
4. 参考 `docs/故障排查` 目录下的文档

### Q3: FFmpeg 配置问题

**解决方案**:
1. 重新运行 `setup-ffmpeg-windows.ps1`
2. 确认环境变量已设置：`$env:FFMPEG_DIR`
3. 重启 PowerShell
4. 或使用模拟数据模式：运行 `quick-test-setup.ps1`

### Q4: 编译错误

**解决方案**:
1. 清理编译缓存：`cargo clean`
2. 更新依赖：`cargo update`
3. 检查 Rust 版本：`rustc --version`（建议 1.70+）
4. 查看详细错误信息并参考文档

---

## 📚 相关文档

- [快速开始](快速开始/README.md) - 项目入门指南
- [开发指南](开发指南/README.md) - 开发环境配置
- [测试指南](测试指南/README.md) - 测试方法和流程
- [故障排查](故障排查/README.md) - 常见问题解决方案

---

## 🔄 脚本维护

### 已删除的脚本

以下脚本已被删除，因为功能重复或已过时：

- `start-all.ps1` - 被 `start-all-simple.ps1` 替代
- `start-all.sh` - Linux/Mac 版本，项目主要在 Windows 运行
- `quick-test-live-streaming.ps1` - 功能已被 `test-live-streaming.ps1` 完全覆盖

### 脚本依赖关系

```
setup-ffmpeg-windows.ps1 (可选)
    ↓
quick-test-setup.ps1 (配置)
    ↓
start-all-simple.ps1 (启动)
    ↓
test-live-streaming.ps1 (测试)

或者直接使用:
run-full-test.ps1 (一键执行所有步骤)
```

---

**最后更新**: 2024-12-13
