# 测试执行指南

## 快速开始

### 一键执行（最简单）

```powershell
.\run-full-test.ps1
```

这个脚本会自动完成：
1. ✅ 配置测试环境（使用模拟数据）
2. ✅ 编译所有组件
3. ✅ 启动所有服务
4. ✅ 验证服务状态
5. ✅ 运行自动化测试
6. ✅ 生成测试报告

**预计时间**: 15-20分钟

---

## 分步执行（推荐用于调试）

### 步骤 1: 配置环境

```powershell
.\quick-test-setup.ps1
```

**作用**: 配置使用模拟数据，编译所有组件  
**时间**: 5-10分钟

### 步骤 2: 启动服务

```powershell
.\start-all-simple.ps1
```

**作用**: 启动平台服务器、设备模拟器、前端  
**时间**: 10-20秒

### 步骤 3: 运行测试

```powershell
.\test-live-streaming.ps1
```

**作用**: 执行6个测试场景，生成测试报告  
**时间**: 2-3分钟

---

## 手动测试

### 通过浏览器

1. 访问 http://localhost:5173
2. 选择设备 `device_001`
3. 点击 "直通播放" 按钮
4. 观察视频播放和统计信息

### 通过API

```powershell
# 启动直通播放
$body = @{
    mode = "live"
    source = @{ device_id = "device_001" }
    config = @{
        client_id = "test_client"
        low_latency_mode = $true
        target_latency_ms = 100
    }
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "http://localhost:8080/api/v1/stream/start" -Method POST -Body $body -ContentType "application/json"

Write-Host "Session ID: $($response.data.session_id)"
```

---

## 查看结果

### 测试报告

```powershell
Get-ChildItem test-results-*.json | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | Get-Content | ConvertFrom-Json | ConvertTo-Json -Depth 10
```

### 服务日志

```powershell
$jobIds = Get-Content ".job-ids.json" | ConvertFrom-Json
Receive-Job -Id $jobIds.Platform -Keep | Select-Object -Last 20
Receive-Job -Id $jobIds.Device -Keep | Select-Object -Last 20
```

---

## 停止服务

```powershell
$jobIds = Get-Content ".job-ids.json" | ConvertFrom-Json
Stop-Job -Id $jobIds.Platform,$jobIds.Device,$jobIds.Frontend
Remove-Job -Id $jobIds.Platform,$jobIds.Device,$jobIds.Frontend
```

---

## 预期结果

### 成功标准

- ✅ 所有服务正常启动
- ✅ 设备在线
- ✅ 直通播放启动成功
- ✅ 视频分片实时传输
- ✅ 端到端延迟 < 100ms
- ✅ 暂停/恢复功能正常
- ✅ 测试通过率 ≥ 80%

---

## 故障排查

### 问题: 编译失败

**检查**:
```powershell
cd device-simulator
cargo build 2>&1 | Select-Object -Last 50
```

**解决**: 参考 `编译问题修复指南.md`

### 问题: 服务无法启动

**检查端口占用**:
```powershell
netstat -ano | findstr "8080"
netstat -ano | findstr "8443"
netstat -ano | findstr "5173"
```

### 问题: 设备不在线

**查看设备日志**:
```powershell
$jobIds = Get-Content ".job-ids.json" | ConvertFrom-Json
Receive-Job -Id $jobIds.Device -Keep | Select-Object -Last 50
```

---

## 性能基准

| 指标 | 目标值 |
|------|--------|
| 端到端延迟（平均） | < 100ms |
| 端到端延迟（P95） | < 100ms |
| 平台处理延迟 | < 5ms |
| 帧率 | 30 fps |
| CPU占用（设备端） | < 20% |
| CPU占用（平台端） | < 5% |

---

**更新时间**: 2025-12-13
