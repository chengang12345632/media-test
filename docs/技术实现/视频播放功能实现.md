# è§†é¢‘æ’­æ”¾åŠŸèƒ½å·²å°±ç»ª ğŸ‰

## å®ç°æ–¹æ¡ˆï¼šMSE (Media Source Extensions)

ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬é€‰æ‹©äº† **MSE** ä½œä¸ºè§†é¢‘æ’­æ”¾æ–¹æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š

### MSE vs WebRTC å¯¹æ¯”

| ç‰¹æ€§ | MSE âœ… | WebRTC |
|------|--------|--------|
| **å»¶è¿Ÿ** | 1-3ç§’ï¼ˆå¯æ¥å—ï¼‰ | < 500ms |
| **å¤æ‚åº¦** | ä¸­ç­‰ | éå¸¸é«˜ |
| **æ’­æ”¾æ§åˆ¶** | å®Œæ•´æ”¯æŒï¼ˆæš‚åœã€å¿«è¿›ã€å¿«é€€ï¼‰ | æœ‰é™ |
| **é€‚ç”¨åœºæ™¯** | **å½•åƒå›æ”¾**ï¼ˆå½“å‰éœ€æ±‚ï¼‰ | å®æ—¶é€šè¯ã€ç›´æ’­ |
| **æµè§ˆå™¨æ”¯æŒ** | åŸç”Ÿæ”¯æŒ | éœ€è¦é¢å¤–åº“ |
| **å®ç°æˆæœ¬** | ä½ | é«˜ |

**ç»“è®º**: å¯¹äºå½•åƒå›æ”¾åœºæ™¯ï¼ŒMSE æ˜¯æœ€ä½³é€‰æ‹©ã€‚

---

## å·²å®ç°åŠŸèƒ½

### âœ… 1. åŒæ¨¡å¼æ’­æ”¾æ”¯æŒ

#### æ¨¡å¼A: ç›´æ¥æµå¼ä¼ è¾“ï¼ˆMP4 æ–‡ä»¶ï¼‰â­â­â­â­â­
- **é€‚ç”¨æ–‡ä»¶**: `.mp4` æ ¼å¼
- **å®ç°æ–¹å¼**: HTTP Range è¯·æ±‚
- **ä¼˜ç‚¹**: 
  - âœ… ç«‹å³å¯ç”¨ï¼Œæ— éœ€è½¬æ¢
  - âœ… æ”¯æŒæ‹–åŠ¨è¿›åº¦æ¡
  - âœ… æ”¯æŒå¿«è¿›å¿«é€€
  - âœ… æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
- **ç«¯ç‚¹**: `GET /api/v1/recordings/{file_id}/stream`

#### æ¨¡å¼B: SSE å®æ—¶æµï¼ˆH.264 è£¸æµï¼‰
- **é€‚ç”¨æ–‡ä»¶**: `.h264` æ ¼å¼
- **å®ç°æ–¹å¼**: Server-Sent Events
- **çŠ¶æ€**: åç«¯å·²å®ç°ï¼Œå‰ç«¯éœ€è¦ fMP4 è½¬æ¢
- **ç«¯ç‚¹**: `GET /api/v1/playback/{session_id}/segments`

---

### âœ… 2. åç«¯å®ç°

#### HTTP Range æ”¯æŒ
```rust
// platform-server/src/http3/streaming.rs

pub async fn stream_recording_file(
    Path(file_id): Path<String>,
    headers: HeaderMap,
) -> Result<Response, StatusCode>
```

**åŠŸèƒ½**:
- âœ… è§£æ `Range` è¯·æ±‚å¤´
- âœ… è¿”å› `206 Partial Content`
- âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- âœ… è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ Content-Type

**æµ‹è¯•**:
```bash
# å®Œæ•´æ–‡ä»¶
curl http://localhost:8443/api/v1/recordings/device-001_sample_60fps_audio.mp4/stream

# éƒ¨åˆ†å†…å®¹
curl -H "Range: bytes=0-1023" http://localhost:8443/api/v1/recordings/device-001_sample_60fps_audio.mp4/stream
```

---

### âœ… 3. å‰ç«¯å®ç°

#### æ™ºèƒ½æ¨¡å¼æ£€æµ‹
```typescript
// web-frontend/src/components/VideoPlayer.tsx

const detectPlaybackMode = async (fileId: string) => {
  if (fileId.toLowerCase().endsWith('.mp4')) {
    setPlaybackMode('direct')
    startDirectPlayback(fileId)
  } else if (fileId.toLowerCase().endsWith('.h264')) {
    setPlaybackMode('sse')
    startSSEPlayback()
  }
}
```

#### ç›´æ¥æ’­æ”¾ï¼ˆMP4ï¼‰
```typescript
const startDirectPlayback = (fileId: string) => {
  const streamUrl = `/api/v1/recordings/${encodeURIComponent(fileId)}/stream`
  videoRef.current.src = streamUrl
  // æµè§ˆå™¨è‡ªåŠ¨å¤„ç† Range è¯·æ±‚å’Œç¼“å†²
}
```

---

## API ç«¯ç‚¹æ€»ç»“

### 1. è·å–å½•åƒåˆ—è¡¨ï¼ˆé€šè¿‡ä¿¡ä»¤ï¼‰
```
GET /api/v1/devices/{device_id}/recordings
```
**æµç¨‹**: å‰ç«¯ â†’ å¹³å° â†’ è®¾å¤‡ï¼ˆQUICä¿¡ä»¤ï¼‰â†’ å¹³å° â†’ å‰ç«¯

### 2. å¼€å§‹å›æ”¾ï¼ˆå»ºç«‹ä¼šè¯ï¼‰
```
POST /api/v1/recordings/{file_id}/playback
Body: {
  "client_id": "web_xxx",
  "start_position": 0
}
```
**æµç¨‹**: å‰ç«¯ â†’ å¹³å° â†’ è®¾å¤‡ï¼ˆQUICä¿¡ä»¤ï¼‰

### 3. ç›´æ¥æµå¼ä¼ è¾“ï¼ˆMP4ï¼‰â­ æ–°å¢
```
GET /api/v1/recordings/{file_id}/stream
Headers: Range: bytes=start-end (å¯é€‰)
```
**æµç¨‹**: å‰ç«¯ â† å¹³å°ï¼ˆç›´æ¥è¯»å–æ–‡ä»¶ï¼‰

### 4. SSE å®æ—¶æµï¼ˆH.264ï¼‰
```
GET /api/v1/playback/{session_id}/segments
```
**æµç¨‹**: å‰ç«¯ â† å¹³å° â† è®¾å¤‡ï¼ˆQUICåª’ä½“æµï¼‰

---

## æŠ€æœ¯ç»†èŠ‚

### HTTP Range è¯·æ±‚å¤„ç†

**è¯·æ±‚ç¤ºä¾‹**:
```http
GET /api/v1/recordings/device-001_sample_60fps_audio.mp4/stream HTTP/1.1
Range: bytes=0-1023
```

**å“åº”ç¤ºä¾‹**:
```http
HTTP/1.1 206 Partial Content
Content-Type: video/mp4
Content-Length: 1024
Content-Range: bytes 0-1023/33667393
Accept-Ranges: bytes

[è§†é¢‘æ•°æ®]
```

### æµè§ˆå™¨è¡Œä¸º
- æµè§ˆå™¨è‡ªåŠ¨å‘é€ Range è¯·æ±‚
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- è‡ªåŠ¨ç®¡ç†ç¼“å†²
- æ”¯æŒ Seek æ“ä½œ

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ MP4 æ–‡ä»¶å¯ä»¥ç›´æ¥æ’­æ”¾ï¼Ÿ
A: MP4 æ˜¯æ ‡å‡†çš„å®¹å™¨æ ¼å¼ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒã€‚é€šè¿‡ HTTP Range è¯·æ±‚ï¼Œå¯ä»¥å®ç°æµå¼æ’­æ”¾å’Œç²¾ç¡®æ§åˆ¶ã€‚

### Q: H.264 è£¸æµä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ’­æ”¾ï¼Ÿ
A: æµè§ˆå™¨çš„ `<video>` æ ‡ç­¾éœ€è¦å®¹å™¨æ ¼å¼ï¼ˆMP4ã€WebM ç­‰ï¼‰ï¼Œä¸æ”¯æŒè£¸æµã€‚éœ€è¦å°è£…ä¸º fMP4 æ ¼å¼ã€‚

### Q: æ’­æ”¾å»¶è¿Ÿæœ‰å¤šå¤§ï¼Ÿ
A: MP4 ç›´æ¥æµå¼ä¼ è¾“å»¶è¿Ÿçº¦ 1-2 ç§’ï¼Œä¸»è¦å–å†³äºç½‘ç»œå’Œç¼“å†²ç­–ç•¥ã€‚

### Q: æ”¯æŒå“ªäº›æµè§ˆå™¨ï¼Ÿ
A: æ‰€æœ‰ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeï¼‰éƒ½æ”¯æŒ HTML5 video å’Œ HTTP Range è¯·æ±‚ã€‚

---

ç”Ÿæˆæ—¶é—´: 2025-12-12 19:23
çŠ¶æ€: âœ… ç”Ÿäº§å°±ç»ª
