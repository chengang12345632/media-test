<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»Ÿä¸€ä½å»¶è¿Ÿè§†é¢‘æµ - ä½¿ç”¨ç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      color: #555;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    input, select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    video {
      width: 100%;
      display: block;
    }

    .stats {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .stat-item {
      padding: 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .stat-label {
      color: #666;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .stat-value {
      color: #333;
      font-size: 14px;
      font-weight: bold;
    }

    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 4px;
      padding: 2px 0;
    }

    .log-time {
      color: #858585;
    }

    .log-info {
      color: #4ec9b0;
    }

    .log-warn {
      color: #dcdcaa;
    }

    .log-error {
      color: #f48771;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¡ ç»Ÿä¸€ä½å»¶è¿Ÿè§†é¢‘æµä¼ è¾“ç³»ç»Ÿ - ä½¿ç”¨ç¤ºä¾‹</h1>

    <!-- é…ç½®åŒºåŸŸ -->
    <div class="section">
      <h2>1. é…ç½®</h2>
      <div class="controls">
        <select id="modeSelect">
          <option value="live">ç›´é€šæ’­æ”¾ (Live)</option>
          <option value="playback">å½•åƒå›æ”¾ (Playback)</option>
        </select>
        <input type="text" id="sourceInput" placeholder="è®¾å¤‡IDæˆ–æ–‡ä»¶ID" value="device_001">
        <input type="number" id="startPosition" placeholder="èµ·å§‹ä½ç½®(ç§’)" value="0" min="0" step="0.1">
        <button onclick="startStream()">å¯åŠ¨æµ</button>
        <button onclick="stopStream()" disabled id="stopBtn">åœæ­¢æµ</button>
      </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
    <div class="section">
      <h2>2. è§†é¢‘æ’­æ”¾</h2>
      <div class="video-container">
        <video id="video" controls></video>
      </div>
    </div>

    <!-- æ’­æ”¾æ§åˆ¶åŒºåŸŸ -->
    <div class="section">
      <h2>3. æ’­æ”¾æ§åˆ¶</h2>
      <div class="controls">
        <button onclick="pauseStream()" disabled id="pauseBtn">æš‚åœ</button>
        <button onclick="resumeStream()" disabled id="resumeBtn">æ¢å¤</button>
        <input type="number" id="seekPosition" placeholder="å®šä½ä½ç½®(ç§’)" min="0" step="0.1" disabled>
        <button onclick="seekStream()" disabled id="seekBtn">å®šä½</button>
        <select id="rateSelect" disabled>
          <option value="0.25">0.25x</option>
          <option value="0.5">0.5x</option>
          <option value="1.0" selected>1.0x</option>
          <option value="1.5">1.5x</option>
          <option value="2.0">2.0x</option>
          <option value="4.0">4.0x</option>
        </select>
        <button onclick="setRate()" disabled id="rateBtn">è®¾ç½®å€é€Ÿ</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ -->
    <div class="section">
      <h2>4. ç»Ÿè®¡ä¿¡æ¯</h2>
      <div class="stats">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">ä¼šè¯ID</div>
            <div class="stat-value" id="sessionId">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">æ¨¡å¼</div>
            <div class="stat-value" id="mode">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">çŠ¶æ€</div>
            <div class="stat-value" id="state">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å½“å‰ä½ç½®</div>
            <div class="stat-value" id="position">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">æ¥æ”¶åˆ†ç‰‡æ•°</div>
            <div class="stat-value" id="segments">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">æ¥æ”¶æ•°æ®</div>
            <div class="stat-value" id="bytes">0 MB</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å¹³å‡å»¶è¿Ÿ</div>
            <div class="stat-value" id="avgLatency">- ms</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å½“å‰å»¶è¿Ÿ</div>
            <div class="stat-value" id="curLatency">- ms</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ååé‡</div>
            <div class="stat-value" id="throughput">- Mbps</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—åŒºåŸŸ -->
    <div class="section">
      <h2>5. æ—¥å¿—</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let currentSessionId = null
    let eventSource = null
    let mediaSource = null
    let sourceBuffer = null
    let segmentQueue = []
    let isAppending = false
    let stats = {
      segments: 0,
      bytes: 0
    }

    // æ—¥å¿—å‡½æ•°
    function log(message, level = 'info') {
      const logDiv = document.getElementById('log')
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = `log-entry log-${level}`
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
      console.log(`[${level.toUpperCase()}]`, message)
    }

    // å¯åŠ¨æµ
    async function startStream() {
      const mode = document.getElementById('modeSelect').value
      const source = document.getElementById('sourceInput').value
      const startPosition = parseFloat(document.getElementById('startPosition').value) || 0

      if (!source) {
        log('è¯·è¾“å…¥è®¾å¤‡IDæˆ–æ–‡ä»¶ID', 'error')
        return
      }

      try {
        log(`å¯åŠ¨${mode === 'live' ? 'ç›´é€šæ’­æ”¾' : 'å½•åƒå›æ”¾'}...`, 'info')

        const config = {
          mode: mode,
          source: mode === 'live' 
            ? { device_id: source }
            : { 
                file_id: source,
                start_position: startPosition,
                playback_rate: 1.0
              },
          config: {
            client_id: 'web_example_001',
            low_latency_mode: true,
            target_latency_ms: mode === 'live' ? 50 : 100
          }
        }

        const response = await fetch('https://localhost:8443/api/v1/stream/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        })

        if (!response.ok) {
          const error = await response.json()
          throw new Error(error.message)
        }

        const data = await response.json()
        currentSessionId = data.session_id

        log(`æµä¼šè¯å·²åˆ›å»º: ${currentSessionId}`, 'info')
        updateUI('started', mode)
        updateStats(data)

        // åˆå§‹åŒ–MSEæ’­æ”¾å™¨
        initMSEPlayer()

        // è¿æ¥SSE
        connectSSE(data.stream_url)

        // å®šæœŸæŸ¥è¯¢çŠ¶æ€
        startStatusPolling()

      } catch (error) {
        log(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // åˆå§‹åŒ–MSEæ’­æ”¾å™¨
    function initMSEPlayer() {
      const video = document.getElementById('video')
      
      if (!window.MediaSource) {
        log('æµè§ˆå™¨ä¸æ”¯æŒMSE', 'error')
        return
      }

      mediaSource = new MediaSource()
      video.src = URL.createObjectURL(mediaSource)

      mediaSource.addEventListener('sourceopen', () => {
        log('MediaSourceå·²æ‰“å¼€', 'info')
        
        const mimeType = 'video/mp4; codecs="avc1.64001f"'
        if (!MediaSource.isTypeSupported(mimeType)) {
          log(`ä¸æ”¯æŒçš„MIMEç±»å‹: ${mimeType}`, 'error')
          return
        }

        sourceBuffer = mediaSource.addSourceBuffer(mimeType)
        sourceBuffer.mode = 'sequence'

        sourceBuffer.addEventListener('updateend', () => {
          isAppending = false
          processSegmentQueue()
        })

        log('SourceBufferå·²åˆ›å»º', 'info')
      })
    }

    // è¿æ¥SSE
    function connectSSE(streamUrl) {
      const fullUrl = `https://localhost:8443${streamUrl}`
      log(`è¿æ¥SSE: ${fullUrl}`, 'info')

      eventSource = new EventSource(fullUrl)

      eventSource.onopen = () => {
        log('SSEè¿æ¥å·²å»ºç«‹', 'info')
      }

      eventSource.addEventListener('segment', (event) => {
        try {
          const segment = JSON.parse(event.data)
          handleSegment(segment)
        } catch (error) {
          log(`å¤„ç†åˆ†ç‰‡å¤±è´¥: ${error.message}`, 'error')
        }
      })

      eventSource.onerror = (error) => {
        log('SSEè¿æ¥é”™è¯¯', 'error')
        console.error(error)
      }
    }

    // å¤„ç†åˆ†ç‰‡
    function handleSegment(segment) {
      stats.segments++
      
      // è§£ç Base64
      const binaryString = atob(segment.data)
      const bytes = new Uint8Array(binaryString.length)
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i)
      }

      stats.bytes += bytes.length

      // åŠ å…¥é˜Ÿåˆ—
      segmentQueue.push(bytes.buffer)
      processSegmentQueue()

      // æ›´æ–°ç»Ÿè®¡
      document.getElementById('segments').textContent = stats.segments
      document.getElementById('bytes').textContent = (stats.bytes / 1024 / 1024).toFixed(2) + ' MB'
    }

    // å¤„ç†åˆ†ç‰‡é˜Ÿåˆ—
    function processSegmentQueue() {
      if (isAppending || segmentQueue.length === 0 || !sourceBuffer) {
        return
      }

      if (sourceBuffer.updating) {
        return
      }

      const segment = segmentQueue.shift()
      isAppending = true

      try {
        sourceBuffer.appendBuffer(segment)
      } catch (error) {
        log(`è¿½åŠ åˆ†ç‰‡å¤±è´¥: ${error.message}`, 'error')
        isAppending = false
      }
    }

    // æ’­æ”¾æ§åˆ¶
    async function pauseStream() {
      await sendControl('pause')
    }

    async function resumeStream() {
      await sendControl('resume')
    }

    async function seekStream() {
      const position = parseFloat(document.getElementById('seekPosition').value)
      if (isNaN(position)) {
        log('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½ç½®', 'warn')
        return
      }
      await sendControl('seek', { position })
    }

    async function setRate() {
      const rate = parseFloat(document.getElementById('rateSelect').value)
      await sendControl('set_rate', { rate })
    }

    async function sendControl(command, params = {}) {
      if (!currentSessionId) return

      try {
        const response = await fetch(
          `https://localhost:8443/api/v1/stream/${currentSessionId}/control`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command, ...params })
          }
        )

        const data = await response.json()
        log(`æ§åˆ¶å‘½ä»¤ ${command} æ‰§è¡ŒæˆåŠŸ`, 'info')
        
      } catch (error) {
        log(`æ§åˆ¶å‘½ä»¤å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // åœæ­¢æµ
    async function stopStream() {
      if (!currentSessionId) return

      try {
        await fetch(`https://localhost:8443/api/v1/stream/${currentSessionId}`, {
          method: 'DELETE'
        })

        log('æµå·²åœæ­¢', 'info')
        cleanup()
        updateUI('stopped')

      } catch (error) {
        log(`åœæ­¢å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // æ¸…ç†èµ„æº
    function cleanup() {
      if (eventSource) {
        eventSource.close()
        eventSource = null
      }

      if (mediaSource && mediaSource.readyState === 'open') {
        mediaSource.endOfStream()
      }

      const video = document.getElementById('video')
      video.src = ''

      currentSessionId = null
      segmentQueue = []
      stats = { segments: 0, bytes: 0 }
    }

    // å®šæœŸæŸ¥è¯¢çŠ¶æ€
    let statusInterval = null
    function startStatusPolling() {
      if (statusInterval) clearInterval(statusInterval)
      
      statusInterval = setInterval(async () => {
        if (!currentSessionId) {
          clearInterval(statusInterval)
          return
        }

        try {
          const response = await fetch(
            `https://localhost:8443/api/v1/stream/${currentSessionId}/status`
          )
          const data = await response.json()
          updateStats(data)
        } catch (error) {
          // å¿½ç•¥é”™è¯¯
        }
      }, 1000)
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(data) {
      if (data.session_id) {
        document.getElementById('sessionId').textContent = 
          data.session_id.substring(0, 8) + '...'
      }
      if (data.mode) {
        document.getElementById('mode').textContent = 
          data.mode === 'live' ? 'ç›´é€šæ’­æ”¾' : 'å½•åƒå›æ”¾'
      }
      if (data.state) {
        document.getElementById('state').textContent = data.state
      }
      if (data.current_position !== undefined) {
        document.getElementById('position').textContent = 
          data.current_position.toFixed(2) + 's'
      }
      if (data.stats) {
        const s = data.stats
        if (s.average_latency_ms !== undefined) {
          document.getElementById('avgLatency').textContent = 
            s.average_latency_ms.toFixed(2) + ' ms'
        }
        if (s.current_latency_ms !== undefined) {
          document.getElementById('curLatency').textContent = 
            s.current_latency_ms.toFixed(2) + ' ms'
        }
        if (s.throughput_mbps !== undefined) {
          document.getElementById('throughput').textContent = 
            s.throughput_mbps.toFixed(2) + ' Mbps'
        }
      }
    }

    // æ›´æ–°UIçŠ¶æ€
    function updateUI(state, mode = null) {
      const isStarted = state === 'started'
      const isPlayback = mode === 'playback'

      document.getElementById('stopBtn').disabled = !isStarted
      document.getElementById('pauseBtn').disabled = !isStarted
      document.getElementById('resumeBtn').disabled = !isStarted
      document.getElementById('seekPosition').disabled = !isStarted || !isPlayback
      document.getElementById('seekBtn').disabled = !isStarted || !isPlayback
      document.getElementById('rateSelect').disabled = !isStarted || !isPlayback
      document.getElementById('rateBtn').disabled = !isStarted || !isPlayback
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', () => {
      log('ç¤ºä¾‹é¡µé¢å·²åŠ è½½', 'info')
      log('è¯·é…ç½®å‚æ•°å¹¶ç‚¹å‡»"å¯åŠ¨æµ"æŒ‰é’®', 'info')
    })

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      cleanup()
    })
  </script>
</body>
</html>
