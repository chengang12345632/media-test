# 编译问题修复指南

## 常见编译错误

### 问题 1: FFmpeg依赖问题（Windows）

**症状**:
```
thread 'main' panicked: called `Result::unwrap()` on an `Err` value: 
Could not run `pkg-config`
```

**原因**: Windows上ffmpeg-next需要pkg-config工具和FFmpeg开发库

---

## 解决方案

### 方案 A: 使用模拟数据（推荐用于快速测试）⭐

1. 修改 `device-simulator/src/video/mod.rs`:
   ```rust
   pub use live_stream_generator_mock::LiveStreamGenerator;
   ```

2. 注释FFmpeg依赖（`device-simulator/Cargo.toml`）

3. 重新编译

**优点**: 快速、无需配置、可验证核心功能  
**缺点**: 无真实屏幕录制、性能数据不准确

---

### 方案 B: 配置FFmpeg环境（推荐用于生产）

#### 步骤1: 安装pkg-config

选项A - 使用Chocolatey:
```powershell
choco install pkgconfiglite
```

选项B - 手动安装:
1. 下载: https://sourceforge.net/projects/pkgconfiglite/files/
2. 解压到 `C:\pkg-config`
3. 添加到PATH

#### 步骤2: 安装FFmpeg开发库

1. 下载FFmpeg开发库:
   - 访问: https://github.com/BtbN/FFmpeg-Builds/releases
   - 下载: `ffmpeg-master-latest-win64-gpl-shared.zip`

2. 解压到 `C:\ffmpeg`

3. 设置环境变量:
```powershell
$env:FFMPEG_DIR = "C:\ffmpeg"
$env:PKG_CONFIG_PATH = "C:\ffmpeg\lib\pkgconfig"
$env:PATH += ";C:\ffmpeg\bin"
```

#### 步骤3: 重新编译

```powershell
cd device-simulator
cargo clean
cargo build
```

---

### 方案 C: 使用Linux/macOS

```bash
# Linux
sudo apt-get install libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

# macOS
brew install ffmpeg
```

---

## 验证步骤

### 验证pkg-config安装
```powershell
pkg-config --version
```

### 验证FFmpeg库
```powershell
pkg-config --libs --cflags libavutil
pkg-config --libs --cflags libavcodec
```

### 验证编译
```powershell
cd device-simulator
cargo build
```

---

## 其他编译问题

### 问题 2: 依赖版本冲突

```powershell
cargo clean
cargo update
cargo build
```

### 问题 3: scrap库编译失败

**解决方案**:
1. 检查是否有屏幕录制权限
2. 在Windows上可能需要安装Visual Studio Build Tools

---

## 参考资料

- [FFmpeg-Builds Releases](https://github.com/BtbN/FFmpeg-Builds/releases)
- [pkg-config for Windows](https://sourceforge.net/projects/pkgconfiglite/)
- [ffmpeg-next文档](https://docs.rs/ffmpeg-next/)

---

**更新时间**: 2025-12-13
