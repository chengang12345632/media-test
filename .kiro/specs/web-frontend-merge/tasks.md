# Web Frontend 功能合并任务列表

## 实施计划

本任务列表将 web-frontend2 的新功能合并到 web-frontend 中，采用增量式方法确保安全性和向后兼容性。

---

## 阶段 1: 新增文件复制和基础设施

- [x] 1. 复制配置管理模块




  - 复制 `web-frontend2/src/config.ts` 到 `web-frontend/src/config.ts`
  - 验证文件编译无错误
  - 确保配置常量正确导出
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ]* 1.1 编写配置模块单元测试
  - 测试默认配置加载（边缘情况）
  - 测试配置常量导出（HTTP_API_URL, WEBTRANSPORT_ENABLED, WEBTRANSPORT_URL, CERT_HASH）
  - 测试配置打印到控制台
  - _需求: 1.1, 1.4_

- [ ]* 1.2 编写配置模块属性测试
  - **属性 1: 环境变量配置注入**
  - **验证: 需求 1.2**
  - 生成随机配置对象，模拟环境变量注入，验证导出值一致
  - 运行至少 100 次迭代
  - _需求: 1.2_

- [ ] 2. 复制 WebTransport 客户端服务
  - 复制 `web-frontend2/src/services/webtransport.ts` 到 `web-frontend/src/services/webtransport.ts`
  - 验证文件编译无错误
  - 确保所有接口和类型正确导出
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.8_

- [ ]* 2.1 编写 WebTransportClient 单元测试
  - 测试浏览器支持检查 (`isSupported()`)
  - 测试证书哈希转换 (`base64ToArrayBuffer()`)
  - 测试 UUID 字节转字符串 (`uuidToString()`)
  - 测试连接断开时的错误回调
  - _需求: 3.2, 3.7_

- [ ]* 2.2 编写协议头部解析属性测试
  - **属性 4: 协议头部解析**
  - **验证: 需求 3.3**
  - 生成随机分片元数据，编码为45字节头部，解析并验证一致性
  - 运行至少 100 次迭代
  - _需求: 3.3_

- [ ]* 2.3 编写精确字节读取属性测试
  - **属性 5: 精确字节读取**
  - **验证: 需求 3.4**
  - 生成随机长度数据流和读取长度序列，验证 readExactly 返回正确字节数
  - 运行至少 100 次迭代
  - _需求: 3.4_

- [ ]* 2.4 编写缓冲区拼接属性测试
  - **属性 6: 缓冲区拼接一致性**
  - **验证: 需求 3.5**
  - 生成随机数据块序列（模拟分片传输），验证跨块读取的数据一致性
  - 运行至少 100 次迭代
  - _需求: 3.5_

- [ ]* 2.5 编写播放控制属性测试
  - **属性 3: 播放控制响应**
  - **验证: 需求 3.6**
  - 生成随机控制命令序列，验证命令正确编码和发送
  - 运行至少 100 次迭代
  - _需求: 3.6_

- [ ]* 2.6 编写延迟计算属性测试
  - **属性 7: 延迟计算正确性**
  - **验证: 需求 3.8**
  - 生成随机发送时间戳，模拟接收并计算延迟，验证延迟为非负数且在合理范围内
  - 运行至少 100 次迭代
  - _需求: 3.8_

- [ ] 3. 复制 WebTransportPlayer 组件
  - 复制 `web-frontend2/src/components/WebTransportPlayer.tsx` 到 `web-frontend/src/components/WebTransportPlayer.tsx`
  - 验证文件编译无错误
  - 确保组件正确导入 config 和 webtransport 服务
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [ ]* 3.1 编写 WebTransportPlayer 单元测试
  - 测试浏览器不支持时的错误显示（WebTransport 和 WebCodecs）
  - 测试连接建立后的状态显示
  - 测试组件卸载时的资源清理
  - _需求: 2.2, 2.3, 2.4, 2.7_

- [ ]* 3.2 编写统计信息更新属性测试
  - **属性 2: 统计信息更新**
  - **验证: 需求 2.5**
  - 生成随机视频分片序列，模拟分片接收，验证统计信息单调递增且在合理范围内
  - 运行至少 100 次迭代
  - _需求: 2.5_

- [ ] 4. 安装测试依赖
  - 安装 `fast-check` 用于属性测试
  - 安装 `@testing-library/react` 和 `@testing-library/jest-dom` 用于组件测试
  - 验证测试框架配置正确
  - _需求: 所有测试相关需求_

---

## 阶段 2: App 组件集成

- [ ] 5. 更新 App 组件以支持 WebTransportPlayer
  - 在 `web-frontend/src/App.tsx` 中导入 WebTransportPlayer 和 config
  - 添加直通播放模式的条件渲染逻辑
  - 在 `state.view === 'live'` 时使用 WebTransportPlayer
  - 传递 sessionId 和 serverUrl 属性
  - 保持现有 VideoPlayer 的使用不变
  - _需求: 2.1, 4.1, 4.2, 4.3_

- [ ]* 5.1 编写 App 组件单元测试
  - 测试直通播放模式使用 WebTransportPlayer
  - 测试录像回放模式使用 VideoPlayer
  - 测试属性传递（sessionId, serverUrl）
  - 测试返回时的资源清理
  - 测试 WebTransport 禁用时的回退
  - _需求: 4.1, 4.2, 4.3, 4.4, 5.4_

---

## 阶段 3: 向后兼容性验证

- [ ] 6. 验证现有功能完整性
  - 手动测试 VideoPlayer 的 MP4 播放功能
  - 手动测试 WebCodecsPlayer 的 H.264 播放功能
  - 手动测试设备列表和录像列表功能
  - 确保所有现有功能正常工作
  - _需求: 5.1, 5.2, 5.3_

- [ ]* 6.1 编写向后兼容性属性测试
  - **属性 8: VideoPlayer 功能保持**
  - **验证: 需求 5.1**
  - 测试 VideoPlayer 的 MP4 播放功能与合并前一致
  - _需求: 5.1_

- [ ]* 6.2 编写录像回放功能属性测试
  - **属性 9: 录像回放功能保持**
  - **验证: 需求 5.2**
  - 测试录像回放流程（选择设备 → 选择录像 → 播放）与合并前一致
  - _需求: 5.2_

- [ ]* 6.3 编写设备和录像列表功能属性测试
  - **属性 10: 设备和录像列表功能保持**
  - **验证: 需求 5.3**
  - 测试设备列表和录像列表的操作与合并前一致
  - _需求: 5.3_

---

## 阶段 4: 集成测试和端到端验证

- [ ]* 7. 编写端到端集成测试
  - 测试完整的直通播放流程（启动应用 → 选择设备 → 启动直通播放 → 验证 WebTransportPlayer 渲染）
  - 测试完整的录像回放流程（启动应用 → 选择设备 → 选择录像 → 验证 VideoPlayer 渲染）
  - 测试直通播放中的视频流接收和统计信息更新
  - 测试播放控制命令（暂停/恢复/倍速）
  - 测试返回上一页时的资源清理
  - _需求: 2.5, 2.6, 2.7, 4.4_

- [ ]* 7.1 编写浏览器兼容性集成测试
  - 在支持的浏览器中测试（Chrome 97+, Edge 97+）
  - 在不支持的浏览器中测试错误提示
  - _需求: 2.2, 2.3_

---

## 阶段 5: 构建配置和文档

- [ ] 8. 更新 Vite 构建配置
  - 在 `web-frontend/vite.config.ts` 中添加环境变量注入
  - 配置 `__APP_CONFIG__` 全局变量
  - 支持 `VITE_HTTP_API_URL`, `VITE_WEBTRANSPORT_ENABLED`, `VITE_WEBTRANSPORT_URL` 环境变量
  - 验证构建成功
  - _需求: 1.2_

- [ ] 9. 更新项目文档
  - 更新 README.md，添加 WebTransport 功能说明
  - 添加浏览器兼容性要求（Chrome 97+, Edge 97+）
  - 添加环境变量配置说明
  - 添加 WebTransport 使用指南
  - 添加故障排查指南
  - _需求: 所有需求_

---

## 阶段 6: 最终验证和清理

- [ ] 10. 运行所有测试并验证覆盖率
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行所有集成测试
  - 验证测试覆盖率 > 80%
  - 修复所有失败的测试
  - _需求: 所有需求_

- [ ] 11. 性能测试和优化
  - 测试 WebTransport 播放的端到端延迟
  - 验证延迟 < 50ms
  - 测试内存使用情况
  - 测试 FPS 稳定性
  - 根据测试结果进行优化
  - _需求: 非功能性需求（性能）_

- [ ] 12. 最终手动测试
  - 在 Chrome 97+ 中测试所有功能
  - 在 Edge 97+ 中测试所有功能
  - 测试直通播放的超低延迟体验
  - 测试录像回放功能
  - 测试错误处理和边缘情况
  - _需求: 所有需求_

- [ ] 13. 代码审查和清理
  - 审查所有新增和修改的代码
  - 移除调试日志和注释
  - 确保代码风格一致
  - 更新代码注释和文档字符串
  - _需求: 非功能性需求（可维护性）_

---

## 回滚计划

如果在任何阶段遇到问题，可以按以下步骤回滚：

1. **阶段 1 回滚**: 删除新增的 3 个文件（config.ts, webtransport.ts, WebTransportPlayer.tsx）
2. **阶段 2 回滚**: 使用 git 恢复 App.tsx 到原始版本
3. **阶段 3-6 回滚**: 删除测试文件和文档更新（不影响功能）

---

## 注意事项

- 每个阶段完成后，运行 `npm run build` 验证编译成功
- 每个阶段完成后，运行现有测试确保没有破坏现有功能
- 标记为 `*` 的任务是可选的测试任务，可以根据时间和资源决定是否实施
- 所有属性测试必须运行至少 100 次迭代
- 所有属性测试必须使用注释标注对应的设计文档属性（格式: `// Feature: web-frontend-merge, Property N: ...`）
